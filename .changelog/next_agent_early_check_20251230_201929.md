Moved next_agent special case handling to execute before JSON parsing attempts to prevent parsing errors.
